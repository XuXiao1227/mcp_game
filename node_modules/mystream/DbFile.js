var async = require('async');
var dc = require('db').dc;

/**
 * 实现事件驱动的数据库文件流
 * @constructor
 */
var DbFile = function(file_id)
{
    var self = this;
    self.file_id = file_id;
    self.start = 0;
};

/**
 * 开始(继续)读取文件
 */
DbFile.prototype.readStart = function()
{
    var self = this;
    var table = dc.pg.get("file_block");
    var cond = {start:self.start, file_id:self.file_id};
    table.find(cond, {}, function(err, data){
        if(data && data.affected > 0)
        {
            var set = data.rst[0];
            var content = set.content;
            var buf = new Buffer(content, "base64");
            self.start = self.start + set.size;
            self.on_data(buf);
        }
        else
        {
            self.on_end();
        }
    });
};

module.exports = DbFile;